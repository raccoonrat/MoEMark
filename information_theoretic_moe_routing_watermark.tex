%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Template for USENIX papers.
% Based on usenix2020_SOUPS.sty template
% MoE路由水印的信息论形式化定义
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[letterpaper,twocolumn,10pt]{article}
\usepackage{usenix2020_SOUPS}

% Chinese support packages
\usepackage{xeCJK}
\setCJKmainfont{SimSun}  % 使用宋体，如果没有可以改为其他中文字体
\setCJKsansfont{SimHei}  % 使用黑体
\setCJKmonofont{FangSong}  % 使用仿宋

% Additional packages
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{url}
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{array}

%-------------------------------------------------------------------------------
\begin{document}
%-------------------------------------------------------------------------------

%don't want date printed
\date{}

% make title bold and 14 pt font
\title{\Large \bf MoE路由水印的信息论形式化定义\\
\large Information-Theoretic Formalization of MoE Routing Watermarking}

%for single author (just remove % characters)
\author{
{\rm Yunhao}\\
\and
{\rm Yilong}\\
\and
{\rm Qingxiao}\\
} % end author

\maketitle

%-------------------------------------------------------------------------------
\begin{abstract}
%-------------------------------------------------------------------------------
本文提出了混合专家（MoE）架构中路由水印的信息论形式化框架。与以往假设可直接控制路由器输出的方法不同，我们认识到路由器是一个习得的函数，只能通过修改模型参数来间接影响其行为。我们建立了基于参数扰动的信道模型：编码器将水印消息映射为模型参数的结构化扰动 $\Delta\theta$，信道是数据分布 $p(x)$ 对这些扰动的响应，输出是验证者在测试集上观测到的激活模式统计量。我们量化了激活模式（组合码）的编码容量，并揭示了其在语义层面释义攻击下的脆弱性：水印可能对触发器输入过拟合，只学习表层token关联而非语义关联。在约束模型性能和隐蔽性的条件下，我们建立了二维率失真（Rate-Distortion）框架，同时考虑性能失真 $D_{\text{perf}}$ 和统计失真 $D_{\text{detect}}$。我们提出了基于约束优化的编码器算法，引入语义一致性约束来对抗释义攻击，通过带约束的微调过程实现水印嵌入。我们重新定义了鲁棒性，将其拆分为参数鲁棒性 $\mathcal{R}_{\text{param}}$ 和语义鲁棒性 $\mathcal{R}_{\text{input}}$，并建立了四维帕累托前沿。在验证过程中，我们将问题形式化为复合假设检验，采用广义似然比检验（GLRT）或序贯概率比检验（SPRT）构建验证器，并基于 Chernoff/Bhattacharyya 上界间接推导了检测质量的 AUC 下界。最后，我们定义了综合性能指标和扩展的帕累托前沿，为 MoE 路由水印的设计和评估提供了严格的理论基础。
\end{abstract}


%-------------------------------------------------------------------------------
\section{引言}
%-------------------------------------------------------------------------------

混合专家（Mixture-of-Experts, MoE）架构通过稀疏激活机制实现了大型神经网络的高效设计。在 MoE 架构中，路由器（Router）负责为每个输入令牌选择性地激活专家子集，这种路由机制为水印嵌入提供了独特的信息载体。然而，目前缺乏对 MoE 路由水印的理论分析框架，特别是从信息论角度对其容量和检测能力的严格量化。

\textbf{核心挑战}：以往的理论框架存在根本性缺陷，即假设可以直接控制路由器的输出（如路由分布 $\mathbf{r}$、激活集合 $\Sigma$ 等）。然而，在深度学习的现实中，路由器是一个习得的函数 $\mathbf{r} = \text{Router}(x)$，我们无法直接控制其输出，只能通过修改模型参数（如路由器的权重 $\mathbf{w}, b$）或训练过程来间接影响它。

本文提出了 MoE 路由水印的信息论形式化定义，旨在为路由水印的设计和评估提供理论基础。我们建立了基于参数扰动的信道模型，将编码器定义为从水印消息到模型参数扰动的映射，信道是数据分布对这些扰动的响应。我们量化了激活模式（组合码）的编码容量。在此基础上，我们建立了二维率失真框架，同时考虑性能失真和统计失真（隐蔽性），并提出了基于约束优化的编码器算法。本文的贡献包括：

\begin{itemize}
\item 建立了基于参数扰动的信道模型，明确了编码器、信道和输出的定义，避免了"直接控制输出"的错误假设
\item 量化了激活模式（组合码）的编码容量，这是最稳定的信息维度
\item 建立了二维率失真（Rate-Distortion）框架，同时考虑性能失真 $D_{\text{perf}}$ 和统计失真 $D_{\text{detect}}$（隐蔽性）
\item 提出了基于约束优化的编码器算法，引入语义一致性约束来对抗释义攻击，通过带约束的微调过程实现水印嵌入，使用基于间隔的水印损失函数
\item 揭示了 $I_{\text{pattern}}$ 地基的脆弱性：水印可能对触发器输入过拟合，只学习表层token关联而非语义关联，导致在释义攻击下实际可实现鲁棒容量可能骤降为 0
\item 重新定义了鲁棒性，将其拆分为参数鲁棒性 $\mathcal{R}_{\text{param}}$ 和语义鲁棒性 $\mathcal{R}_{\text{input}}$，并建立了四维帕累托前沿
\item 构建了基于复合假设检验的验证框架（GLRT/SPRT），强调只使用激活模式特征进行验证
\item 深入分析了语义层面释义攻击对水印检测的影响，揭示了过拟合问题并提出了语义一致性约束的应对策略
\end{itemize}

%-------------------------------------------------------------------------------
\section{基础符号与系统定义}
%-------------------------------------------------------------------------------

\subsection{MoE路由机制基础}

设 MoE 模型的第 $l$ 层为：
$$\text{MoE}_l(x) = \sum_{i=1}^{n} g_i(x) \cdot E_i(x)$$

其中：
\begin{itemize}
\item $x \in \mathbb{R}^d$：输入向量
\item $g_i(x)$：第 $i$ 个专家的路由权重（由路由器 Router 产生）
\item $E_i(x)$：第 $i$ 个专家的输出
\item $n$：专家总数
\end{itemize}

\textbf{路由器输出}：
$$\mathbf{r} = \text{Router}(x) = \text{Softmax}(\mathbf{w}^T x + b) \in \Delta^{n-1}$$

其中 $\text{Softmax}(\cdot)$ 为 softmax 函数，得到路由分布 $\mathbf{r} = [r_1, r_2, \ldots, r_n]$，位于概率单纯形 $\Delta^{n-1} = \{\mathbf{r} \in \mathbb{R}^n: r_i \geq 0, \sum_{i=1}^n r_i = 1\}$。温度参数 $T$ 用于控制分布的锐度：$\text{Softmax}_T(\mathbf{z})_i = \exp(z_i/T) / \sum_j \exp(z_j/T)$。

\subsection{水印系统定义}

水印系统 $\mathcal{W} = (\mathcal{E}, \mathcal{V})$ 包括：
\begin{itemize}
\item $\mathcal{E}$：嵌入过程（Embedding），将水印消息 $m$ 映射为模型参数的结构化扰动 $\Delta\theta$
\item $\mathcal{V}$：验证过程（Verification），从测试集上的观测特征推断模型是否包含水印
\end{itemize}

\textbf{关键认识}：与以往假设可以直接控制路由器输出的方法不同，我们认识到：
\begin{itemize}
\item \textbf{路由器是一个习得的函数}：$\mathbf{r} = \text{Router}(x) = \text{Softmax}(\mathbf{w}^T x + b)$，我们无法直接控制其输出
\item \textbf{编码器的真正任务}：不是直接控制 $\mathcal{S}(x)$，而是通过参数扰动 $\Delta\theta$ 在数据分布 $p(x)$ 上使 $\mathcal{S}(x)$ 的统计分布 $p(\mathcal{S}|\theta_{\text{wm}})$ 发生可检测的、偏向消息 $m$ 的偏移
\item \textbf{信道模型}：
  \begin{itemize}
  \item \textbf{输入}：参数扰动 $\Delta\theta$（而非消息 $m$ 或路由状态 $\mathcal{S}(x)$）
  \item \textbf{信道}：数据分布 $p(x)$ 对 $\Delta\theta$ 的"探测"和"响应"，同一个 $\Delta\theta$ 在不同输入 $x_i$ 上产生不同的 $\mathcal{S}(x_i)$
  \item \textbf{输出}：验证者在测试集 $\mathcal{T} = \{x_1, \ldots, x_N\}$ 上观测到的特征统计量 $\mathbf{f} = [\mathcal{F}(x_1), \ldots, \mathcal{F}(x_N)]$
  \end{itemize}
\end{itemize}

%-------------------------------------------------------------------------------
\section{水印信息的编码空间}
%-------------------------------------------------------------------------------

\subsection{路由状态空间}

对于输入 $x$，在第 $l$ 层的路由状态表示为：
$$\mathcal{S}(x) = (\mathbf{r}, \Sigma, \pi) \in \Delta^{n-1} \times 2^{[n]} \times S_k$$

其中：
\begin{itemize}
\item $\mathbf{r} \in \Delta^{n-1}$：路由分布向量（位于概率单纯形）
\item $\Sigma \subset [n]$：激活的专家集合，满足 $|\Sigma| = k$（top-$k$ 稀疏门控）
\item $\pi \in S_k$：激活顺序（排列），表示 $\Sigma$ 中专家按路由权重降序排列
\end{itemize}

为避免记号歧义，我们明确区分：$\text{Softmax}(\cdot)$ 表示函数，$\Sigma$ 表示激活集合，$\pi$ 表示排列。

\subsection{可用信息维度}

路由状态空间提供了三个主要的信息维度用于编码水印：

\textbf{维度1：激活模式（组合码）}

从 $n$ 个专家中选择 $k$ 个激活，信息容量为：
$$I_{\text{pattern}} = \log_2 \binom{n}{k} = \log_2 \frac{n!}{k!(n-k)!}$$

对于 $n=128, k=2$ 的典型配置，使用斯特林近似（Stirling's approximation）：
$$I_{\text{pattern}} \approx 13 \text{ bits}$$

\textbf{维度2：排列顺序（排列码）}

对前 $k$ 个专家的排列，信息容量为：
$$I_{\text{order}} = \log_2(k!)$$

对于 $k=4$：
$$I_{\text{order}} = \log_2(24) \approx 4.6 \text{ bits}$$

\textbf{注意}：该容量仅在"前 $k$ 专家可完全排序且可控"的假设下成立。若路由器含温度缩放或分数权重相近导致排序不稳定，应引入有限分辨率/随机噪声的"有效容量"修正。

\textbf{维度3：权重量化（连续码）}

由于 $\mathbf{r} \in \Delta^{n-1}$ 且满足 $\sum_i r_i = 1$，自由度为 $(n-1)$。在 top-$k$ 稀疏门控下，仅对激活的 $k$ 个专家权重进行量化，且满足 $\sum_{i \in \Sigma} r_i = 1$，因此自由度为 $(k-1)$。假设每个路由权重 $r_i$（$i \in \Sigma$）量化为 $b$-bit 精度：
$$I_{\text{weight}} \leq (k-1) \cdot b \text{ bits}$$

对于 $k=4, b=4$（16级量化）：
$$I_{\text{weight}} \leq 12 \text{ bits}$$

考虑温度 $T$ 与归一化噪声 $\sigma$ 的影响，有效容量需乘以系数 $\eta(T, \sigma) \in (0,1)$：
$$I_{\text{weight}}^{\text{eff}} = \eta(T, \sigma) \cdot (k-1) \cdot b$$

\textbf{总容量上界}：
\begin{align}
C_{\max} &= I_{\text{pattern}} + I_{\text{order}} + I_{\text{weight}}^{\text{eff}} \nonumber \\
&= \log_2 \binom{n}{k} + \log_2(k!) + \eta(T, \sigma) \cdot (k-1) \cdot b
\end{align}

%-------------------------------------------------------------------------------
\section{信息容量的量化}
%-------------------------------------------------------------------------------

\subsection{可实现容量（Achievable Capacity）与编码本视角}

从编码本（Codebook）视角，编码器 $\mathcal{E}$ 将水印消息 $m$ 映射为模型参数的结构化扰动 $\Delta\theta$。信道模型为"参数扰动 $\Delta\theta$ → 数据分布 $p(x)$ 的响应 → 路由状态的后验分布 $p(\mathcal{S}(x)|\theta_{\text{wm}})$ → 验证统计量 $\mathbf{f}$"。

在约束模型性能和隐蔽性的条件下，可实现的容量定义为：
$$C_{\text{achievable}} = \max_{p(m), p(\Delta\theta|m)} I(m; \mathbf{f})$$

其中 $\mathbf{f} = [\mathcal{F}(x_1), \ldots, \mathcal{F}(x_N)]$ 为测试集 $\mathcal{T}$ 上的特征统计量，$I(\cdot; \cdot)$ 为互信息。

\textbf{特征选择}：排列码 $I_{\text{order}}$ 和权重量化 $I_{\text{weight}}$ 在语义变化下不稳定。因此，验证者 $\mathcal{V}$ 应该只依赖于激活模式 $\Sigma$。信道输出 $\mathbf{f}$ 可以被精简为：在 $N$ 个样本上观测到的\textbf{激活模式 $\Sigma$ 的经验分布（或计数向量）}。

\subsection{率失真（Rate-Distortion）问题}

与以往针对单个输入 $x$ 的路由分布 $\mathbf{r}$ 定义失真的方法不同，我们必须在数据分布 $p(x)$ 上定义失真。率失真函数被重新定义为：

\begin{align}
R(D_{\text{perf}}, D_{\text{detect}}) &= \max_{p(m), p(\Delta\theta|m)} I(m; \mathbf{f}) \nonumber \\
&\quad \text{s.t.} \quad D_{\text{perf}} \leq \epsilon_1, \quad D_{\text{detect}} \leq \epsilon_2
\end{align}

其中失真是一个\textbf{二维向量} $D = (D_{\text{perf}}, D_{\text{detect}})$：

\begin{enumerate}
\item \textbf{性能失真 $D_{\text{perf}}$}：嵌入水印对模型主要任务造成的损害
$$D_{\text{perf}} = \Delta_{\text{perf}} = \text{Acc}_{\text{clean}} - \text{Acc}_{\text{watermarked}}$$

\item \textbf{统计失真 $D_{\text{detect}}$（可隐蔽性）}：水印在路由统计上留下的痕迹，可被量化为干净模型和水印模型在路由输出分布上的 KL 散度
$$D_{\text{detect}} = \mathbb{E}_{x \sim p(x)} \left[D_{\text{KL}}\left(p(\mathcal{S}(x)|\theta_{\text{clean}}) || p(\mathcal{S}(x)|\theta_{\text{wm}})\right)\right]$$
\end{enumerate}

\textbf{失真的双重作用}：
\begin{itemize}
\item $D_{\text{detect}}$ 越小，水印越\textbf{隐蔽}（越难被攻击者发现）
\item $D_{\text{detect}}$ 越大，水印越\textbf{可检测}（越容易被验证者验证）
\end{itemize}

\textbf{信息-性能-隐蔽性权衡}：通过扫描超参数（如 $\lambda_{\text{wm}}$），可以凭经验绘制出 $R(D_{\text{perf}}, D_{\text{detect}})$ 的帕累托前沿，其中：
\begin{itemize}
\item X轴：$D_{\text{perf}}$（模型准确率下降）
\item Y轴：$R$（水印检测器的统计显著性或 AUC）
\item Z轴：$D_{\text{detect}}$（隐蔽性，越小越好）
\end{itemize}

%-------------------------------------------------------------------------------
\section{基于约束优化的编码器算法}
%-------------------------------------------------------------------------------

\subsection{问题的形式化定义}

编码器 $\mathcal{E}$ 的任务是将水印消息 $m$ 映射为模型参数扰动 $\Delta\theta$。这可以形式化为一个约束优化问题：

\begin{align}
\max_{\Delta\theta} \quad &\underbrace{\mathbb{E}_{x \sim p(x)} \left[\log p(\Sigma_m | x, \theta_{\text{clean}} + \Delta\theta)\right]}_{\text{水印强度 (R)}} \nonumber \\
&\quad - \lambda_1 \underbrace{\Delta\mathcal{L}_{\text{task}}(\Delta\theta)}_{\text{性能失真 ($D_{\text{perf}}$)}} - \lambda_2 \underbrace{D_{\text{detect}}(\Delta\theta)}_{\text{隐蔽性失真 ($D_{\text{detect}}$)}}
\end{align}

其中：
\begin{itemize}
\item $m \rightarrow \Sigma_m$：通过带密钥 $K$ 的哈希函数 $H_K(m)$ 将消息 $m$ 映射到目标激活模式 $\Sigma_m$（例如，对于 $n=8, k=2$，共有 $\binom{8}{2} = 28$ 种可能的激活模式）
\item $\lambda_1, \lambda_2$：拉格朗日乘子，用于在 $R$、$D_{\text{perf}}$ 和 $D_{\text{detect}}$ 之间进行权衡，构成帕累托前沿
\end{itemize}

\subsection{实用的优化算法}

我们不需要从头开始求解上述问题，可以将其构建为一个\textbf{带约束的微调（Fine-tuning）过程}：

\textbf{算法：基于约束优化的水印嵌入}

\begin{enumerate}
\item \textbf{目标定义}：选择消息 $m$，通过哈希函数 $H_K(m)$ 生成目标激活模式 $\Sigma_m$。

\item \textbf{损失函数设计}：定义复合损失函数 $\mathcal{L}_{\text{total}}$ 来微调 $\theta_{\text{clean}}$：
$$\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}}(x) + \lambda_{\text{wm}} \cdot \mathcal{L}_{\text{wm}}(x) + \lambda_{\text{con}} \cdot \mathcal{L}_{\text{con}}(x, x')$$

其中：
\begin{itemize}
\item $\mathcal{L}_{\text{task}}$：原始模型任务损失（如交叉熵），确保保持在 $D_{\text{perf}} \leq \epsilon_1$ 的约束内
\item $\lambda_{\text{wm}}$：水印强度超参数，直接控制 $R$ 和 $D_{\text{perf}}$ 之间的权衡
\item $\mathcal{L}_{\text{wm}}$：水印损失，用于实现 $\max p(\Sigma_m)$ 的目标
\item $\lambda_{\text{con}}$：语义一致性强度超参数，控制 $\mathcal{R}_{\text{input}}$ 和 $\Delta_{\text{perf}}$ 之间的权衡
\item $\mathcal{L}_{\text{con}}$：语义一致性约束，定义为 $\mathcal{L}_{\text{con}}(x, x') = \text{Dist}(\mathcal{S}(x), \mathcal{S}(x'))$，其中 $x'$ 是 $x$ 的语义等价释义，$\text{Dist}$ 是路由状态之间的距离度量（如 KL 散度或总变分距离）
\end{itemize}

\item \textbf{水印损失 $\mathcal{L}_{\text{wm}}$ 的设计}：对于一个输入 $x$，路由器产生 $n$ 个 logits：$\mathbf{l} = [l_1, \ldots, l_n]$。我们的目标是使目标模式 $\Sigma_m$ 中的专家成为 Top-$k$。采用\textbf{基于间隔（Margin-based）的损失}：

\begin{itemize}
\item 找到 $\Sigma_m$ 中的最低分：$l_{\min\_\text{target}} = \min_{i \in \Sigma_m} l_i$
\item 找到\textbf{非} $\Sigma_m$ 中的最高分：$l_{\max\_\text{other}} = \max_{i \notin \Sigma_m} l_i$
\item \textbf{损失函数}：$\mathcal{L}_{\text{wm}} = \text{ReLU}(l_{\max\_\text{other}} - l_{\min\_\text{target}} + \text{margin})$
\end{itemize}

该损失的含义是："要求目标专家（$\Sigma_m$ 中）的最低分，必须比所有其他专家的最高分还要高出一个 $\text{margin}$。如果这个条件满足，损失为0；否则，就施加一个惩罚。"

\item \textbf{执行编码}：使用 $\mathcal{L}_{\text{total}}$ 对 $\theta_{\text{clean}}$（或仅仅是路由器参数）进行微调几个（甚至几十个）epoch。

这个过程\textbf{自动}找到了一个"折衷"的 $\Delta\theta$：
\begin{itemize}
\item 它只在那些\textbf{不会}严重损害 $\mathcal{L}_{\text{task}}$ 的输入 $x$ 上"悄悄地"推高 $\Sigma_m$ 的概率
\item 它在"最容易"被操纵的输入上嵌入水印，而不是在所有输入上强行嵌入
\item $\lambda_{\text{wm}}$ 的大小直接控制了 $R$ 和 $D_{\text{perf}}$ 之间的权衡
\item $\lambda_{\text{con}}$ 的大小直接控制了 $\mathcal{R}_{\text{input}}$ 和 $\Delta_{\text{perf}}$ 以及 $C_{\text{achievable}}$ 之间的权衡
\item 通过 $\mathcal{L}_{\text{con}}$，模型被迫学习语义层面的特征，而非仅仅依赖表层token关联，从而提高了对释义攻击的鲁棒性
\end{itemize}
\end{enumerate}

\subsection{与理论框架的连接}

该算法完美地连接回了形式化框架：

\begin{itemize}
\item \textbf{编码器 $\mathcal{E}$}：不再是简单的加法 $\tilde{\mathbf{w}} = \mathbf{w} + \delta \mathbf{b}_{\text{target}}$，而是一个\textbf{优化过程}（即上述的微调算法）

\item \textbf{可实现容量 $C_{\text{achievable}}$}：容量 $R$ 不再是理论上的 $\log_2 \binom{n}{k}$，而是由 $\lambda_{\text{wm}}$ 控制的、在 $D_{\text{perf}}$ 和 $D_{\text{detect}}$ 约束下的\textbf{实际}互信息 $I(m; \mathbf{f})$

\item \textbf{率失真 $R(D)$}：可以通过\textbf{扫描 $\lambda_{\text{wm}}$} 来凭经验绘制出 $R(D_{\text{perf}}, D_{\text{detect}})$ 曲线，完美体现了"信息-性能-隐蔽性权衡"的思想
\end{itemize}

%-------------------------------------------------------------------------------
\section{语义层面释义攻击的影响}
%-------------------------------------------------------------------------------

\subsection{释义攻击的定义}

在实际应用中，水印面临的主要挑战是\textbf{语义层面的释义攻击}（Paraphrasing Attack）。攻击者通过保持语义不变但改变输入表达的方式来尝试移除或破坏水印。例如，对于文本生成任务，攻击者可能将原始输入"解释量子计算的基本原理"改写为"阐述量子计算的核心概念"，虽然语义相同，但词汇和表达方式发生了变化。

设原始输入为 $x$，其语义等价的释义为 $x'$，满足：
$$\text{Semantic}(x) \approx \text{Semantic}(x')$$

其中 $\text{Semantic}(\cdot)$ 表示输入的语义内容。

\subsection{释义对路由状态的影响}

由于路由器 $\text{Router}(x)$ 是一个习得的函数，语义等价的输入 $x$ 和 $x'$ 可能产生不同的路由状态：
$$\mathcal{S}(x) = (\mathbf{r}(x), \Sigma(x), \pi(x)) \neq \mathcal{S}(x') = (\mathbf{r}(x'), \Sigma(x'), \pi(x'))$$

这种差异可能导致：
\begin{itemize}
\item \textbf{激活模式变化}：$\Sigma(x) \neq \Sigma(x')$，即使语义相同，激活的专家集合可能不同
\item \textbf{路由分布偏移}：$\mathbf{r}(x) \neq \mathbf{r}(x')$，路由权重分布发生变化
\end{itemize}

\subsection{水印检测的挑战}

在语义层面释义攻击下，水印检测面临以下挑战：

\begin{enumerate}
\item \textbf{语义不变性要求}：水印应该对语义等价的输入保持稳定，即对于语义等价的 $x$ 和 $x'$，水印检测结果应该一致。

\item \textbf{激活模式的语义关联}：激活模式 $\Sigma(x)$ 应该与输入的语义内容相关，而非仅仅依赖于表面的词汇或表达方式。这要求水印嵌入过程能够学习到语义层面的特征。

\item \textbf{统计分布的稳定性}：在测试集上，即使输入经过释义，激活模式的统计分布 $p(\Sigma|\theta_{\text{wm}})$ 应该保持相对稳定，使得验证者能够检测到水印信号。
\end{enumerate}

\subsection{应对策略：语义一致性约束}

为了修复这个地基，我们的编码器 $\mathcal{E}$ 必须被显著增强。我们不能再使用简单的 $\mathcal{L}_{\text{wm}} = \text{ReLU}(l_{\max\_\text{other}} - l_{\min\_\text{target}} + \text{margin})$。

我们必须引入\textbf{语义一致性约束（Semantic Consistency Constraint）}：

$$\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}}(x) + \lambda_{\text{wm}} \cdot \mathcal{L}_{\text{wm}}(x) + \lambda_{\text{con}} \cdot \text{Dist}(\mathcal{S}(x), \mathcal{S}(x'))$$

其中 $x'$ 是 $x$ 的一个释义（或通过数据增强、对抗性输入产生），$\text{Dist}$ 是一个距离度量，用于惩罚 $x$ 和 $x'$ 之间路由行为的\textbf{不一致性}。

通过这种方式，我们\textbf{强迫} $\Delta\theta$ 去学习一个\textbf{语义鲁棒}的路由偏好。这使得水印嵌入的成本更高（$D_{\text{perf}}$ 可能更大），但 $\mathcal{R}_{\text{input}}$ 也相应增强了。

\textbf{新的权衡关系}：

\begin{enumerate}
\item \textbf{$\mathcal{R}_{\text{input}}$ vs $\Delta_{\text{perf}}$（语义鲁棒性 vs 性能）}：
\begin{itemize}
\item 为了提高 $\mathcal{R}_{\text{input}}$，我们必须提高 $\lambda_{\text{con}}$。
\item 但这迫使模型在语义相似的输入上（$x$ 和 $x'$）给出\textbf{一致}的路由行为。
\item 这是一个\textbf{非常强}的约束，它会干扰模型为 $\mathcal{L}_{\text{task}}$ 所做的正常优化，从而\textbf{不可避免}地导致\textbf{更大的性能下降 $\Delta_{\text{perf}}$}。
\end{itemize}

\item \textbf{$\mathcal{R}_{\text{input}}$ vs $C_{\text{achievable}}$（语义鲁棒性 vs 容量）}：
\begin{itemize}
\item $\mathcal{L}_{\text{con}}$ 约束越多，模型能够"藏匿"水印的"自由空间"就越少。
\item 我们不能再简单地将水印"过拟合"到特定触发词上。我们必须在整个语义簇上嵌入水印。
\item 这使得嵌入单个比特（例如 $\Sigma_m$）的难度\textbf{急剧增加}，因此\textbf{可实现容量 $C_{\text{achievable}}$ 会显著下降}。
\end{itemize}
\end{enumerate}

这再次回到了论文的核心——\textbf{帕累托前沿}：我们现在必须在一个更高维度的空间（$R$, $D_{\text{perf}}$, $D_{\text{detect}}$, $\mathcal{R}_{\text{param}}$, $\mathcal{R}_{\text{input}}$）中寻找权衡。

%-------------------------------------------------------------------------------
\section{验证过程与检测能力}
%-------------------------------------------------------------------------------

\subsection{假设检验框架（复合假设）}

验证问题可形式化为\textbf{复合假设检验}：
\begin{itemize}
\item $H_0$：模型未被水印化（原始模型），参数 $\theta_0 \in \Theta_0$ 未知
\item $H_1$：模型被正确的水印化，参数 $\theta_1 \in \Theta_1$ 未知
\end{itemize}

由于参数未知，$H_0$ 和 $H_1$ 均为复合假设。给定测试集 $\mathcal{T} = \{x_1, \ldots, x_N\}$，提取特征向量：
$$\mathbf{f} = [\mathcal{F}(x_1), \ldots, \mathcal{F}(x_N)]$$

\textbf{特征选择}：排列码 $I_{\text{order}}$ 和权重量化 $I_{\text{weight}}$ 在语义变化下不稳定。因此，验证者 $\mathcal{V}$ 应该\textbf{只依赖于激活模式 $\Sigma$}。特征提取函数 $\mathcal{F}$ 定义为：
$$\mathcal{F}(x) = \Sigma(x)$$

即只提取激活的专家集合。特征向量为：
$$\mathbf{f} = (\Sigma_1, \ldots, \Sigma_N)$$

\textbf{信道输出}：验证者观测到的信道输出 $Y$ 是在 $N$ 个样本上观测到的\textbf{激活模式 $\Sigma$ 的经验分布（或计数向量）}。对于 $n$ 个专家、$k$ 个激活的配置，共有 $\binom{n}{k}$ 种可能的激活模式，因此 $\mathbf{f}$ 可以表示为长度为 $\binom{n}{k}$ 的计数向量，其中每个元素表示对应激活模式在测试集上的出现次数。

\subsection{广义似然比检验（GLRT）与序贯概率比检验（SPRT）}

由于 $H_0$ 和 $H_1$ 为复合假设，采用\textbf{广义似然比检验（GLRT）}以消去未知参数：
$$\Lambda_{\text{GLRT}}(\mathbf{f}) = \frac{\max_{\theta_1 \in \Theta_1} p(\mathbf{f}|\theta_1)}{\max_{\theta_0 \in \Theta_0} p(\mathbf{f}|\theta_0)} \gtrless \tau$$

或采用\textbf{序贯概率比检验（SPRT）}以降低测试样本开销：
$$\Lambda_{\text{SPRT}}(\mathbf{f}_t) = \prod_{i=1}^t \frac{p(\mathbf{f}_i|H_1)}{p(\mathbf{f}_i|H_0)} \gtrless \tau$$

其中 $t$ 为当前样本数，SPRT 可在达到决策阈值时提前终止。

\textbf{检测功率（功效）}定义为：
$$\beta = \inf_{\theta_1 \in \Theta_1} P(\Lambda > \tau | H_1, \theta_1)$$

\textbf{假阳性率}（False Positive Rate）：
$$\alpha = \sup_{\theta_0 \in \Theta_0} P(\Lambda > \tau | H_0, \theta_0)$$

\subsection{ROC曲线与AUC下界（基于错判率上界）}

检测质量由接收者操作特征（ROC）曲线量化：
$$\text{AUC} = \int_0^1 \text{TPR}(\text{FPR}) \, d(\text{FPR})$$

对于信息论上界，我们采用\textbf{Chernoff/Bhattacharyya 上界}先给出\textbf{错判率}或\textbf{Bayes 风险}的指数型上界，再间接推导对 AUC 的保守下界。

\textbf{Bhattacharyya 距离}：
$$D_B = -\ln \int \sqrt{p(\mathbf{f}|H_0) p(\mathbf{f}|H_1)} \, d\mathbf{f}$$

对于高斯分布族，错判率上界为：
$$P_{\text{error}} \leq \exp(-D_B)$$

进而可推导 AUC 的保守下界（需注明适用分布族，如高斯族）：
$$\text{AUC} \geq 1 - \exp(-D_B) - \alpha$$

其中 $\alpha$ 为假阳性率上界。

%-------------------------------------------------------------------------------
\section{综合性能指标}
%-------------------------------------------------------------------------------

\subsection{水印质量函数与帕累托前沿}

\textbf{原始定义的缺陷}：手稿最初将水印质量 $\mathcal{Q}$ 定义为三维指标：$\mathcal{Q} = (C_{\text{achievable}}, \mathcal{R}, \text{AUC})$，其优化目标是 $\max \{C_{\text{achievable}}, \mathcal{R}, \text{AUC}\}$。然而，这里的致命缺陷在于 $\mathcal{R}$（鲁棒性）的定义。手稿中的 $\mathcal{R}$ 是基于极小极大准则定义的，其对抗的攻击族 $\mathcal{A}$ 仅包含了\textbf{参数空间}的攻击（如微调、蒸馏、量化与剪枝），\textbf{完全忽略}了\textbf{输入空间}攻击（文本释义）。一个水印可以对"蒸馏"100\%鲁棒（$\mathcal{R}$ 很高），但对"释义"0\%鲁棒（实际完全不可用）。

\textbf{扩展的质量定义}：我们必须将 $\mathcal{R}$ 拆分为两个\textbf{独立}且\textbf{相互竞争}的指标：

\begin{enumerate}
\item \textbf{$\mathcal{R}_{\text{param}}$（参数鲁棒性）}：即手稿中原有的 $\mathcal{R}$，对抗微调、蒸馏等参数空间攻击。
\item \textbf{$\mathcal{R}_{\text{input}}$（语义鲁棒性）}：\textbf{（手稿缺失）}对抗释义、同义词替换等输入空间规避攻击。
\end{enumerate}

\textbf{新的质量定义}：综合定义水印系统的质量为\textbf{四维指标}：
$$\mathcal{Q} = (C_{\text{achievable}}, \mathcal{R}_{\text{param}}, \mathcal{R}_{\text{input}}, \text{AUC})$$

其中：
\begin{itemize}
\item $C_{\text{achievable}}$：可实现容量
\item $\mathcal{R}_{\text{param}}$：参数鲁棒性（对抗参数修改）
\item $\mathcal{R}_{\text{input}}$：语义鲁棒性（对抗输入空间规避）
\item $\text{AUC}$：检测 AUC
\end{itemize}

\textbf{新的多目标优化}：编码器 $\mathcal{E}$（水印嵌入算法）现在必须在一个更复杂的空间中寻找权衡点：

$$\max \{C_{\text{achievable}}, \mathcal{R}_{\text{param}}, \mathcal{R}_{\text{input}}, \text{AUC}\}$$
$$\text{s.t.} \quad \Delta_{\text{perf}} \leq \epsilon, \quad \alpha \leq \alpha_{\max}$$

\textbf{帕累托前沿}定义为非被支配的解集合，即不存在其他解在所有目标上都不劣于当前解且至少在一个目标上更优。

\textbf{关键权衡关系}：

\begin{enumerate}
\item \textbf{$\mathcal{R}_{\text{input}}$ vs $\Delta_{\text{perf}}$（语义鲁棒性 vs 性能）}：为了提高 $\mathcal{R}_{\text{input}}$，必须提高 $\lambda_{\text{con}}$，但这会干扰模型为 $\mathcal{L}_{\text{task}}$ 所做的正常优化，导致更大的性能下降 $\Delta_{\text{perf}}$。

\item \textbf{$\mathcal{R}_{\text{input}}$ vs $C_{\text{achievable}}$（语义鲁棒性 vs 容量）}：$\mathcal{L}_{\text{con}}$ 约束越多，模型能够"藏匿"水印的"自由空间"就越少，不能再简单地将水印"过拟合"到特定触发词上，必须在整个语义簇上嵌入水印，使得嵌入单个比特的难度急剧增加，因此可实现容量 $C_{\text{achievable}}$ 会显著下降。
\end{enumerate}

\textbf{权重设定}：质量函数的加权形式 $Q_{\text{normalized}} = \alpha C_n + \beta R_{\text{param},n} + \gamma R_{\text{input},n} + \delta A_n$（其中 $\alpha + \beta + \gamma + \delta = 1$）仅用于\textbf{政策选择}（根据具体应用需求选择折中点），而非理论结论。权重来源与任务依赖需明确：不同数据集/任务（如生成式 vs 分类式 MoE）可能需要不同的权重配置。建议以\textbf{Pareto 前沿}为主图呈现不加权的解集，再由应用需求选择折中点。

\textbf{连接开放问题}：这种新框架完美地回应了手稿自己的开放问题，特别是如何构造"稳健验证器"以处理"域漂移"。"文本释义"正是"对抗性域漂移"的一种形式。通过引入 $\mathcal{L}_{\text{con}}$ 作为实现 $\mathcal{R}_{\text{input}}$ 的机制，我们提供了一个具体的工程路径来探索这个更完备、更真实的帕累托前沿，而不是停留在手稿目前这个过于简化的理论模型上。

%-------------------------------------------------------------------------------
\section{数学推导示例}
%-------------------------------------------------------------------------------

\subsection{示例：基于激活模式的水印嵌入}

假设设计仅基于激活模式 $\Sigma$ 进行水印，使用 $n=8$ 个专家、$k=2$ 个激活的配置：

\textbf{信息来源}：从 $n=8$ 个专家中选择 $k=2$ 个激活，共有 $\binom{8}{2} = 28$ 种可能的激活模式
$$I_{\text{pattern}} = \log_2 \binom{8}{2} = \log_2 28 \approx 4.8 \text{ bits}$$

\textbf{消息映射}：通过带密钥 $K$ 的哈希函数 $H_K(m)$ 将消息 $m$（例如 "U-C-Berkeley"）映射到目标激活模式 $\Sigma_m$（例如，$\Sigma_m = \{\text{专家 3, 专家 7}\}$）。

\textbf{编码方案}：使用基于约束优化的微调过程，而非简单的偏置向量加法。定义复合损失函数：
$$\mathcal{L}_{\text{total}} = \mathcal{L}_{\text{task}} + \lambda_{\text{wm}} \cdot \mathcal{L}_{\text{wm}}$$

其中水印损失 $\mathcal{L}_{\text{wm}}$ 采用基于间隔的损失：
$$\mathcal{L}_{\text{wm}} = \text{ReLU}\left(\max_{i \notin \Sigma_m} l_i - \min_{i \in \Sigma_m} l_i + \text{margin}\right)$$

该损失要求目标专家（$\Sigma_m$ 中）的最低 logit 必须比所有其他专家的最高 logit 还要高出一个 $\text{margin}$。

\textbf{性能约束}：在数据分布 $p(x)$ 上的性能失真和统计失真
$$D_{\text{perf}} = \text{Acc}_{\text{clean}} - \text{Acc}_{\text{watermarked}} \leq \epsilon_1$$
$$D_{\text{detect}} = \mathbb{E}_{x \sim p(x)} \left[D_{\text{KL}}\left(p(\mathcal{S}(x)|\theta_{\text{clean}}) || p(\mathcal{S}(x)|\theta_{\text{wm}})\right)\right] \leq \epsilon_2$$

\textbf{可实现容量}：通过扫描 $\lambda_{\text{wm}}$，可以凭经验测量实际互信息 $I(m; \mathbf{f})$，其中 $\mathbf{f}$ 是测试集上激活模式的经验分布。实际容量 $C_{\text{achievable}}$ 通常小于理论容量 $I_{\text{pattern}}$，因为需要在性能失真和统计失真之间进行权衡。

\textbf{检测能力}：基于 Pinsker 不等式，若水印模型和干净模型的路由分布满足 $D_{\text{KL}}(p_{\text{wm}} || p_{\text{clean}}) \geq \delta$，则验证成功率下界为：
$$P_{\text{detect}} \geq 1 - \exp\left(-\frac{\delta}{2}\right) - \alpha$$

其中 $\alpha$ 为假阳性率上界。在语义层面释义攻击下，需要考虑语义等价输入对分布的影响。

%-------------------------------------------------------------------------------
\section{开放的理论问题}
%-------------------------------------------------------------------------------

尽管本文建立了 MoE 路由水印的信息论框架，但仍存在一些开放的理论问题：

\begin{enumerate}
\item \textbf{稀疏门控与单纯形容量的精确化}：在 top-$k$ 稀疏门控与概率单纯形约束下，路由水印的有效自由度与容量是多少？如何用类型法（method of types）为离散部分给出可靠编码区与错误指数？
\item \textbf{嵌入-性能的率失真闭环}：在给定性能降级门限下，能否得到显式的容量上/下界？如何将性能损失上界映射为对路由分布的散度球约束（KL 或 Rényi 散度）？
\item \textbf{复合假设检验的稳健验证器}：如何构造稳健最优的验证器以处理语义层面的释义攻击？如何比较以 $\Sigma$、$\pi$、$\mathbf{r}_\Sigma$ 为特征的不同充分性与功效？
\item \textbf{隐蔽性（Steganographic Security）与可检性下界}：路由分布的统计隐蔽性如何量化？如何定义对手的检测器族并给出最小可辨性下界？
\item \textbf{语义层面的稳定性与泛化能力}：如何设计水印嵌入算法，使得激活模式对语义等价的输入保持稳定？如何量化语义变化对路由状态分布的影响？如何避免水印对触发器输入的过拟合，确保学习到语义概念关联而非表层token关联？
\item \textbf{四维帕累托前沿的探索}：如何在更高维度的空间（$C_{\text{achievable}}$, $\mathcal{R}_{\text{param}}$, $\mathcal{R}_{\text{input}}$, $\text{AUC}$）中寻找最优权衡点？如何量化 $\mathcal{R}_{\text{input}}$ 与 $\Delta_{\text{perf}}$ 以及 $\mathcal{R}_{\text{input}}$ 与 $C_{\text{achievable}}$ 之间的权衡关系？
\end{enumerate}

%-------------------------------------------------------------------------------
\section{结论}
%-------------------------------------------------------------------------------

本文提出了 MoE 路由水印的信息论形式化框架，为路由水印的设计和评估提供了严格的理论基础。与以往假设可直接控制路由器输出的方法不同，我们建立了基于参数扰动的信道模型，明确了编码器、信道和输出的定义。我们量化了激活模式（组合码）的编码容量，并揭示了其在语义层面释义攻击下的脆弱性：水印可能对触发器输入过拟合，只学习表层token关联而非语义关联，导致实际可实现鲁棒容量可能骤降为 0。我们建立了二维率失真框架，同时考虑性能失真 $D_{\text{perf}}$ 和统计失真 $D_{\text{detect}}$（隐蔽性），并提出了基于约束优化的编码器算法，引入语义一致性约束来对抗释义攻击，通过带约束的微调过程实现水印嵌入。我们重新定义了鲁棒性，将其拆分为参数鲁棒性 $\mathcal{R}_{\text{param}}$ 和语义鲁棒性 $\mathcal{R}_{\text{input}}$，并建立了四维帕累托前沿，揭示了 $\mathcal{R}_{\text{input}}$ 与 $\Delta_{\text{perf}}$ 以及 $\mathcal{R}_{\text{input}}$ 与 $C_{\text{achievable}}$ 之间的关键权衡关系。在验证过程中，我们构建了基于复合假设检验的框架（GLRT/SPRT），强调只使用激活模式特征进行验证，并基于错判率上界间接推导了检测质量的 AUC 下界。这些理论结果为 MoE 路由水印的实践应用提供了指导，并为未来的研究指明了方向，包括稀疏门控与单纯形容量的精确化、嵌入-性能-隐蔽性的率失真闭环、复合假设检验的稳健验证器、隐蔽性分析、语义层面的稳定性与泛化能力以及四维帕累托前沿的探索等开放问题。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

